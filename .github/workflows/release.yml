name: Create Release

on:
  # ç¦ç”¨è‡ªåŠ¨ release åˆ›å»º - åº”è¯¥æ‰‹åŠ¨æ§åˆ¶å‘å¸ƒ
  # push:
  #   tags:
  #     - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to create release for (e.g., v4.4.6)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Create Release ZIP
      run: |
        zip -r cross-request-${{ github.ref_name }}.zip . \
          -x "*.git*" \
          -x ".github/*" \
          -x ".DS_Store" \
          -x "CHROME_STORE_GUIDE.md" \
          -x "RELEASE_NOTES.md" \
          -x "*.zip"
    
    - name: Extract release notes
      id: extract_notes
      run: |
        # å°è¯•ä» git tag annotation è·å–å‘å¸ƒè¯´æ˜
        TAG_MESSAGE=$(git tag -l --format='%(contents)' ${{ github.ref_name }})
        
        # å¦‚æœ tag æœ‰ annotationï¼Œä½¿ç”¨å®ƒ
        if [ ! -z "$TAG_MESSAGE" ]; then
          echo "ä½¿ç”¨ git tag annotation ä½œä¸ºå‘å¸ƒè¯´æ˜"
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          echo "$TAG_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          # å¦åˆ™ä» README.md æå–å¯¹åº”ç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—
          echo "ä» README.md æå–æ›´æ–°æ—¥å¿—"
          VERSION=$(echo ${{ github.ref_name }} | sed 's/^v//')
          
          # æå–ç‰ˆæœ¬å¯¹åº”çš„æ›´æ–°å†…å®¹
          RELEASE_NOTES=$(awk -v version="$VERSION" '
            BEGIN { found=0; content=""; in_version=0 }
            /^### v/ { 
              if (in_version && found) exit;
              if ($0 ~ "v" version "[ (]") {
                found=1;
                in_version=1;
                # åŒ…å«ç‰ˆæœ¬æ ‡é¢˜è¡Œ
                content = $0 "\n";
                next;
              } else if (in_version && found) {
                exit;
              }
            }
            found && in_version && !/^### v/ { 
              if (NF > 0 || $0 ~ /^$/) {
                content = content $0 "\n"; 
              }
            }
            END { 
              # æ¸…ç†æœ«å°¾å¤šä½™çš„æ¢è¡Œç¬¦
              gsub(/\n+$/, "", content);
              print content;
            }
          ' README.md)
          
          echo "æå–åˆ°çš„æ›´æ–°æ—¥å¿—å†…å®¹ï¼š"
          echo "---"
          echo "$RELEASE_NOTES"
          echo "---"
          
          # å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”ç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤å†…å®¹
          if [ -z "$RELEASE_NOTES" ] || [ "${RELEASE_NOTES// /}" = "" ]; then
            echo "æœªæ‰¾åˆ°ç‰ˆæœ¬ $VERSION çš„æ›´æ–°æ—¥å¿—ï¼Œä½¿ç”¨é»˜è®¤å†…å®¹"
            RELEASE_NOTES=$(printf "### %s\n\næ­¤ç‰ˆæœ¬çš„æ›´æ–°å†…å®¹è¯·æŸ¥çœ‹ [æäº¤å†å²](https://github.com/%s/commits/%s)ã€‚\n\n#### ğŸ“¦ å®‰è£…æ–¹æ³•\n1. ä¸‹è½½ä¸‹æ–¹çš„ \`cross-request-%s.zip\` æ–‡ä»¶\n2. è§£å‹åˆ°æœ¬åœ°æ–‡ä»¶å¤¹\n3. æ‰“å¼€ Chrome æµè§ˆå™¨ï¼Œè¿›å…¥ \`chrome://extensions/\`\n4. å¼€å¯\"å¼€å‘è€…æ¨¡å¼\"ï¼ˆå³ä¸Šè§’å¼€å…³ï¼‰\n5. ç‚¹å‡»\"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº\"ï¼Œé€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹\n\n#### ğŸ”§ ä¸»è¦åŠŸèƒ½\n- è·¨åŸŸè¯·æ±‚æ”¯æŒï¼Œç»•è¿‡ CORS é™åˆ¶\n- è‡ªåŠ¨ç”Ÿæˆ cURL å‘½ä»¤\n- é¡µé¢å†…å®æ—¶æ˜¾ç¤ºç»“æœ\n- ä¸“ä¸º YApi æ¥å£æµ‹è¯•ä¼˜åŒ–" "${{ github.ref_name }}" "${{ github.repository }}" "${{ github.ref_name }}" "${{ github.ref_name }}")
          fi
          
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        fi
        
        echo "æœ€ç»ˆå‘å¸ƒè¯´æ˜ï¼š"
        echo "==============="
        echo "$RELEASE_NOTES"
        echo "==============="
    
    - name: Create Release
      uses: ncipollo/release-action@v1
      with:
        artifacts: "cross-request-${{ github.ref_name }}.zip"
        tag: ${{ github.ref_name }}
        name: "${{ github.ref_name }} - Cross Request"
        body: ${{ steps.extract_notes.outputs.RELEASE_NOTES }}
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}