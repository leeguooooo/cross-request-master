name: Auto Tag on Version Change

# ç¦ç”¨è‡ªåŠ¨æ ‡ç­¾åˆ›å»º - åº”è¯¥æ‰‹åŠ¨æ§åˆ¶å‘å¸ƒ
# on:
#   push:
#     branches: [ main ]
#     paths: [ 'manifest.json' ]

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to tag (e.g., 4.5.3)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  check-and-tag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get version from input
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "current_version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=v$VERSION" >> $GITHUB_OUTPUT
          echo "å½“å‰ç‰ˆæœ¬: $VERSION"
      
      - name: Check if tag exists
        id: check_tag
        run: |
          if git tag -l | grep -q "^${{ steps.version.outputs.tag_name }}$"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "æ ‡ç­¾ ${{ steps.version.outputs.tag_name }} å·²å­˜åœ¨"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "æ ‡ç­¾ ${{ steps.version.outputs.tag_name }} ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°æ ‡ç­¾"
          fi
      
      - name: Get previous version from git history
        id: prev_version
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          # è·å–ä¸Šä¸€æ¬¡ä¿®æ”¹ manifest.json çš„æäº¤ä¸­çš„ç‰ˆæœ¬å·
          PREV_VERSION=$(git show HEAD~1:manifest.json 2>/dev/null | jq -r '.version' 2>/dev/null || echo "unknown")
          echo "previous_version=$PREV_VERSION" >> $GITHUB_OUTPUT
          echo "ä¸Šä¸€ä¸ªç‰ˆæœ¬: $PREV_VERSION"
      
      - name: Create tag and release notes
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          # é…ç½® git ç”¨æˆ·ä¿¡æ¯
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # ä» README.md æå–ç‰ˆæœ¬æ›´æ–°æ—¥å¿—
          VERSION="${{ steps.version.outputs.current_version }}"
          
          # å°è¯•ä» README.md æå–å¯¹åº”ç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—
          CHANGELOG=$(awk -v version="$VERSION" '
            BEGIN { found=0; content=""; in_version=0 }
            /^### v/ { 
              if (in_version && found) exit;
              if ($0 ~ "v" version "[ (]") {
                found=1;
                in_version=1;
                # è·³è¿‡ç‰ˆæœ¬æ ‡é¢˜è¡Œï¼Œåªæå–å†…å®¹
                next;
              } else if (in_version && found) {
                exit;
              }
            }
            found && in_version && !/^### v/ { 
              if (NF > 0 || $0 ~ /^$/) {
                content = content $0 "\n"; 
              }
            }
            END { 
              # æ¸…ç†æœ«å°¾å¤šä½™çš„æ¢è¡Œç¬¦
              gsub(/\n+$/, "", content);
              if (content == "") {
                print "ç‰ˆæœ¬æ›´æ–°";
              } else {
                print content;
              }
            }
          ' README.md)
          
          echo "æå–åˆ°çš„æ›´æ–°æ—¥å¿—:"
          echo "$CHANGELOG"
          
          # åˆ›å»ºå¸¦æ³¨é‡Šçš„æ ‡ç­¾
          git tag -a "${{ steps.version.outputs.tag_name }}" -m "Cross Request Master v$VERSION
          
          $CHANGELOG
          
          è‡ªåŠ¨å‘å¸ƒäº $(date +'%Y-%m-%d %H:%M:%S')"
          
          # æ¨é€æ ‡ç­¾åˆ°è¿œç¨‹ä»“åº“
          git push origin "${{ steps.version.outputs.tag_name }}"
          
          echo "âœ… æˆåŠŸåˆ›å»ºå¹¶æ¨é€æ ‡ç­¾: ${{ steps.version.outputs.tag_name }}"
      
      - name: Summary
        run: |
          if [ "${{ steps.check_tag.outputs.exists }}" = "true" ]; then
            echo "âš ï¸ æ ‡ç­¾ ${{ steps.version.outputs.tag_name }} å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
            echo "å¦‚éœ€é‡æ–°å‘å¸ƒï¼Œè¯·åˆ é™¤ç°æœ‰æ ‡ç­¾åé‡æ–°æ¨é€ä»£ç "
          else
            echo "âœ… è‡ªåŠ¨åˆ›å»ºæ ‡ç­¾å®Œæˆï¼"
            echo "ğŸ“‹ ç‰ˆæœ¬: ${{ steps.version.outputs.current_version }}"
            echo "ğŸ·ï¸ æ ‡ç­¾: ${{ steps.version.outputs.tag_name }}"
            echo "ğŸš€ å‘å¸ƒå·¥ä½œæµå°†è‡ªåŠ¨è§¦å‘ï¼Œè¯·ç¨å€™æŸ¥çœ‹ Releases é¡µé¢"
          fi